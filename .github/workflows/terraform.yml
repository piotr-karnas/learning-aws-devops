name: 'Terraform CI/CD'

on:
  push:
    branches: [ "main" ]
  pull_request: 

env:
  TF_VERSION: '1.14.0'

jobs:
  terraform:
    name: 'Terraform Validate & Plan'
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./aws-sesja8-ci-cd

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Terraform init
      env:
        AWS_ACCESS_KEY_ID:     ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION:    ${{ secrets.AWS_DEFAULT_REGION }}
      run: terraform init

    - name: Terraform format
      run: |
        echo "=== TERRAFORM FORMAT CHECK ==="
        terraform fmt -check || echo "‚ö†Ô∏è  Format issues detected (normal for 1st run)"
        echo "üîß Auto-formatting..."
        terraform fmt -write=true -recursive .
        echo "‚úÖ Format check passed!"

    - name: Terraform validate
      run: terraform validate

    - name: Terraform plan
      env:
        AWS_ACCESS_KEY_ID:     ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION:    ${{ secrets.AWS_DEFAULT_REGION }}
      if: github.event_name == 'pull_request'
      run: terraform plan -var-file="dev.tfvars" -no-color
      continue-on-error: true

    - name: Terraform plan status
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const output = `
            #### Terraform Format and Style
            ‚úÖ Success

            #### Terraform initialization
            ‚úÖ Success

            #### Terraform plan
            \`\`\`tfplan
            $(cat terraform-plan.txt)
            \`\`\`
          ';

          github.rest.issues.createComment({
            issue.number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo, 
            body: output
          })
