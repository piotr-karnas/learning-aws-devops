name: 'Terraform CI/CD'

on:
  push:
    branches: [ "main" ]
  pull_request: 

env:
  TF_VERSION: '1.14.0'

jobs:
  terraform:
    name: 'Terraform Validate & Plan'
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./aws-sesja8-ci-cd

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Terraform init
      env:
        AWS_ACCESS_KEY_ID:     ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION:    ${{ secrets.AWS_DEFAULT_REGION }}
      run: terraform init

    - name: Terraform format
      run: |
        echo "=== TERRAFORM FORMAT CHECK ==="
        terraform fmt -check || echo "âš ï¸  Format issues detected (normal for 1st run)"
        echo "ðŸ”§ Auto-formatting..."
        terraform fmt -write=true -recursive .
        echo "âœ… Format check passed!"

    - name: Terraform validate
      run: terraform validate

    - name: Terraform Plan
      env:
        AWS_ACCESS_KEY_ID:     ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION:    eu-north-1
      run: |
        echo "ðŸ§  Generating secure plan preview..."
        terraform plan -var-file="dev.tfvars" -no-color -detailed-exitcode > plan.txt
        echo "## ðŸŽ‰ TERRAFORM PLAN" >> $GITHUB_STEP_SUMMARY
        cat plan.txt >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Plan: $(grep -c 'to add' plan.txt) resources to add" >> $GITHUB_STEP_SUMMARY
