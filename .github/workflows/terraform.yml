name: 'Terraform Multi-Env CI/CD'
on:
  pull_request:
  push:
    branches: [ main, dev, staging ]

env:
  TF_VERSION: '1.6.0'

jobs:
  terraform:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'prod' || github.ref_name || 'dev' }}
    defaults:
      run:
        working-directory: ./aws-sesja8-ci-cd
    steps:
    - uses: actions/checkout@v4
    
    - uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
    
    - name: ðŸ”§ Init, Validate, Plan
      env:
        AWS_ACCESS_KEY_ID:     ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION:    eu-north-1
      run: |
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          ENV="pr-${{ github.event.number }}"
        elif [[ "${{ github.ref_name }}" == "main" ]]; then
          ENV="prod"
        elif [[ "${{ github.ref_name }}" == "dev" ]]; then  
          ENV="dev"
        else
          ENV="dev"
        fi
        
        echo "ðŸŸ¢ Detected ENV: $ENV"
        terraform init -backend-config="bucket=aws-sesja8-tfstate" \
                       -backend-config="key=${{ github.ref_name || 'dev' }}/terraform.tfstate" \
                       -backend-config="region=eu-north-1"
        terraform validate
        terraform workspace new $ENV || terraform workspace select $ENV
        terraform plan -var-file="$ENV.tfvars" -no-color -detailed-exitcode > plan.txt
        echo "## ðŸŽ‰ TERRAFORM PLAN [$ENV]" >> $GITHUB_STEP_SUMMARY
        cat plan.txt >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸš€ Terraform Apply
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
      env:
        AWS_ACCESS_KEY_ID:     ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION:    eu-north-1
      run: |
        terraform apply -var-file="$ENV.tfvars" -auto-approve
